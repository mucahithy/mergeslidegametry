<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Merge Slide</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>

*{margin:0;padding:0;box-sizing:border-box}
html,body{overflow:auto;touch-action:none;-webkit-user-select:none;user-select:none}
body{min-height:100vh;min-height:100dvh;background:linear-gradient(170deg,#1A100A 0%,#2D1B0E 35%,#3A2515 65%,#1A100A 100%);display:flex;flex-direction:column;align-items:center;font-family:'Nunito','Segoe UI',sans-serif;padding:8px}
.tabs{display:flex;gap:4px;margin:8px 0 12px;width:100%;max-width:500px}
.tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:800;letter-spacing:1px;border-radius:10px 10px 0 0;cursor:pointer;transition:all .2s}
.tab.active{background:rgba(255,217,61,0.15);color:#FFD93D;border-bottom:3px solid #FFD93D}
.tab:not(.active){background:rgba(0,0,0,0.3);color:#6B5040;border-bottom:3px solid transparent}
.panel{display:none;width:100%;max-width:500px;flex-direction:column;align-items:center}
.panel.active{display:flex}
.board{position:relative;overflow:hidden;background:linear-gradient(145deg,#5C4033,#3E2A1A);border-radius:16px;border:3px solid #6B4F35;box-shadow:inset 0 3px 12px rgba(0,0,0,0.6),0 10px 50px rgba(0,0,0,0.7)}
.cell{position:absolute;background:rgba(0,0,0,0.15);border-radius:6px;cursor:pointer}
.cell:hover{background:rgba(255,255,255,0.08)}
.blk{position:absolute;display:flex;align-items:center;justify-content:center;flex-direction:column;user-select:none;touch-action:none}
.blk .em{pointer-events:none;line-height:1;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.blk .szl{font-size:8px;font-weight:800;color:rgba(255,255,255,0.6);pointer-events:none;margin-top:-2px}
.btn{background:linear-gradient(145deg,#6B4F35,#5C4033);border:2px solid #8B7355;border-radius:10px;padding:9px 18px;font-size:13px;font-weight:800;color:#FFD93D;cursor:pointer;letter-spacing:1px;box-shadow:0 3px 0 #3E2A1A,0 4px 8px rgba(0,0,0,0.3);font-family:'Nunito',sans-serif}
.btn:active{transform:translateY(2px);box-shadow:0 1px 0 #3E2A1A}
.btn.primary{background:linear-gradient(145deg,#FFD93D,#F5A623);color:#2D1B0E;border-color:#cc8800}
.pal-label{font-size:9px;color:#6B5040;font-weight:700;letter-spacing:1px;margin:4px 0 2px}
.palette{display:flex;flex-wrap:wrap;gap:4px;margin:8px 0;justify-content:center}
.pal-item{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;border:2px solid transparent;transition:all .15s;font-size:20px}
.pal-item.selected{border-color:#FFD93D;box-shadow:0 0 12px rgba(255,217,61,0.5)}
.pal-item .psz{font-size:7px;font-weight:800;color:rgba(255,255,255,0.6);margin-top:-3px}
.editor-tools{display:flex;gap:6px;margin:8px 0;flex-wrap:wrap;justify-content:center}
.sz-row{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.sz-row label{color:#8B7355;font-size:11px;font-weight:700}
.sz-input{width:50px;padding:6px;border-radius:8px;border:2px solid #6B4F35;background:#2D1B0E;color:#FFD93D;font-size:14px;font-weight:800;text-align:center;font-family:'Nunito',sans-serif}
.sz-input:focus{outline:none;border-color:#FFD93D}
.sz-x{color:#6B5040;font-size:14px;font-weight:900}
.level-list{width:100%;margin-top:10px}
.level-list-title{font-size:10px;color:#6B5040;font-weight:700;letter-spacing:1.5px;margin-bottom:6px}
.lv-item{display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.25);border-radius:8px;padding:8px 12px;margin-bottom:4px}
.lv-item .lv-name{color:#C4A882;font-size:13px;font-weight:700}
.lv-item .lv-info{color:#6B5040;font-size:10px}
.lv-item .lv-actions{display:flex;gap:4px}
.lv-btn{padding:4px 10px;border-radius:6px;font-size:10px;font-weight:800;cursor:pointer;border:1px solid rgba(255,255,255,0.1);font-family:'Nunito',sans-serif}
.lv-btn.edit{background:#5C4033;color:#FFD93D}
.lv-btn.del{background:#4A2020;color:#FF6B6B}
.lv-btn.mv{background:#3A2515;color:#8B7355;font-size:12px;padding:4px 6px}
.ghost-blk{position:absolute;pointer-events:none;opacity:0.5;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:50}
.play-menu{width:100%;display:flex;flex-direction:column;align-items:center}
.play-title{font-size:32px;font-weight:900;color:#FFD93D;text-shadow:0 3px 15px rgba(255,217,61,0.4);margin:16px 0 4px;letter-spacing:4px}
.play-sub{font-size:11px;color:#7D6040;margin-bottom:16px;font-weight:700}
.level-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;width:100%;max-width:340px;margin-bottom:16px}
.lv-card{aspect-ratio:1;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;position:relative;background:linear-gradient(145deg,#5C4033,#3E2A1A);border:2px solid #8B7355}
.lv-card:hover{border-color:#FFD93D;transform:scale(1.05)}
.lv-card .lv-num{font-size:22px;font-weight:900;color:#FFD93D}
.lv-card .lv-check{position:absolute;top:4px;right:6px;font-size:14px}
.lv-card .lv-sz{font-size:9px;color:#8B7355;font-weight:700}

.play-game{width:100%;display:flex;flex-direction:column;align-items:center}
.play-game.hidden{display:none}
.play-hud{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:500px;margin-bottom:8px}
.play-lv-label{font-size:16px;font-weight:900;color:#FFD93D}
.play-stats{display:flex;gap:8px}
.ps{background:rgba(0,0,0,0.35);border-radius:8px;padding:3px 10px;text-align:center;border:1px solid rgba(255,255,255,0.06)}
.ps .psl{font-size:8px;color:#6B5040;font-weight:700;letter-spacing:1px}
.ps .psv{font-size:15px;font-weight:900}
.blk.dr{cursor:grabbing;z-index:100!important;transform:scale(1.06)!important;transition:left .04s linear,top .04s linear,transform .08s!important}
.blk.merged{z-index:110!important;transform:scale(1.08)!important;transition:left .08s ease-out,top .08s ease-out,transform .08s!important;filter:brightness(1.15)}
.blk.game{cursor:grab;transition:left .12s ease,top .12s ease,transform .12s ease}
.wo{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:1000}
.wo.hid{display:none}
.wb{background:linear-gradient(145deg,#5C4033,#3E2A1A);border-radius:24px;padding:32px 40px;text-align:center;border:3px solid #FFD93D;box-shadow:0 0 100px rgba(255,217,61,0.3);animation:wp .5s ease-out}
.we{font-size:56px}.wtt{font-size:26px;font-weight:900;color:#FFD93D;margin:8px 0}
.wst{color:#C4A882;font-size:15px;margin:4px 0 16px}
.wbtns{display:flex;gap:8px;justify-content:center}
@keyframes po{0%{transform:scale(1);opacity:1;filter:brightness(1)}30%{transform:scale(1.35);filter:brightness(1.8)}100%{transform:scale(0);opacity:0;filter:brightness(3)}}
@keyframes gl{0%{filter:brightness(1);box-shadow:0 0 0 0 rgba(255,215,0,0.8)}50%{filter:brightness(1.5);box-shadow:0 0 28px 14px rgba(255,215,0,0.5)}100%{filter:brightness(1);box-shadow:0 0 0 0 rgba(255,215,0,0)}}
@keyframes pt{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--dx),var(--dy)) scale(0);opacity:0}}
@keyframes rp{0%{background:rgba(255,50,50,0)}20%{background:rgba(255,50,50,0.55)}50%{background:rgba(255,50,50,0.3)}80%{background:rgba(255,50,50,0.55)}100%{background:rgba(255,50,50,0)}}
@keyframes wp{0%{transform:scale(0.4) rotate(-8deg);opacity:0}60%{transform:scale(1.06) rotate(1deg)}100%{transform:scale(1) rotate(0deg);opacity:1}}
@keyframes mp{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5)}}

</style>
</head>
<body>
<div style="width:100%;max-width:500px;display:flex;flex-direction:column;align-items:center">
  <div class="play-menu" id="playMenu">
    <div class="play-title">MERGE SLIDE</div>
    <div class="play-sub">Select a level to play</div>
    <div class="level-grid" id="levelGrid"></div>
  </div>
  <div class="play-game hidden" id="playGame">
    <div class="play-hud">
      <button class="btn" id="pgBack">‚Üê Menu</button>
      <div class="play-lv-label" id="pgLabel">Level 1</div>
      <div class="ps" style="min-width:80px"><div class="psl">‚è± TIME</div><div class="psv" id="pgTimer" style="color:#FFD93D">60</div></div>
    </div>
    <div class="board" id="pgBoard"></div>
    <button class="btn" id="pgRestart" style="margin-top:10px">üîÑ Restart</button>
  </div>
</div>
<div class="wo hid" id="winO"><div class="wb"><div class="we">üéâ</div><h2 class="wtt">LEVEL COMPLETE!</h2><p class="wst" id="winSt"></p><div class="wbtns"><button class="btn" id="winMenu">Menu</button><button class="btn primary" id="winNext">Next Level ‚Üí</button></div></div></div>
<div class="wo hid" id="failO"><div class="wb" style="border-color:#FF6B6B"><div class="we">‚è∞</div><h2 class="wtt" style="color:#FF6B6B">TIME'S UP!</h2><p class="wst">You ran out of time</p><div class="wbtns"><button class="btn" id="failMenu">Menu</button><button class="btn primary" id="failRetry">üîÑ Retry</button></div></div></div>

<script>
(function(){
const CL=46,GP=3,ST=CL+GP;
// GW=columns, GH=rows ‚Äî set per level/editor
let GW=8,GH=8;

const TI={
  1:{w:1,h:1,e:"üêπ",bg:"#FF6B6B",sh:"#C94444"},
  2:{w:1,h:1,e:"üê±",bg:"#FF9F43",sh:"#CC7A2E"},
  3:{w:2,h:1,e:"ü¶ä",bg:"#FECA57",sh:"#CCA03E"},
  4:{w:2,h:1,e:"üê∏",bg:"#48DBFB",sh:"#2EB0CC"},
  5:{w:2,h:2,e:"üê∞",bg:"#A8E6CF",sh:"#6BBF96"},
  6:{w:2,h:2,e:"üêª",bg:"#C59CFF",sh:"#9B70D9"},
  7:{w:2,h:2,e:"üêº",bg:"#B8B8D1",sh:"#8E8EA8"},
  8:{w:2,h:2,e:"ü¶Å",bg:"#A29BFE",sh:"#7E78CC"},
  9:{w:2,h:2,e:"üê®",bg:"#F8B595",sh:"#CC8E6E"},
  10:{w:3,h:2,e:"üêØ",bg:"#FD79A8",sh:"#CC5F85"},
  11:{w:3,h:2,e:"ü¶Ñ",bg:"#55E6C1",sh:"#3BB896"},
  12:{w:3,h:3,e:"üê≤",bg:"#FEA47F",sh:"#CC835F"},
  13:{w:4,h:4,e:"üëë",bg:"#FFD700",sh:"#CCAB00"}
};
const MR={1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10,10:11,11:12,12:13,13:null};
const PLACEABLE=[1,2,3,4,5,6,7,8,9,10,11,12];

function sizeBoard(bd,w,h){bd.style.width=(w*ST+GP)+'px';bd.style.height=(h*ST+GP)+'px'}
function showToast(msg,color){const t=document.createElement('div');t.style.cssText=`position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${color||'#FFD93D'};color:#1A100A;padding:8px 20px;border-radius:10px;font-size:13px;font-weight:800;font-family:'Nunito',sans-serif;z-index:2000;pointer-events:none;opacity:1;transition:opacity .4s`;document.body.appendChild(t);t.textContent=msg;setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),400)},1500)}
function canPlace(t,r,c,bks,ex,gw,gh){const ti=TI[t];if(r<0||c<0||r+ti.h>gh||c+ti.w>gw)return false;for(const b of bks){if(b.id===ex)continue;const a=TI[t],bb=TI[b.tier];if(c<b.col+bb.w&&c+a.w>b.col&&r<b.row+bb.h&&r+a.h>b.row)return false}return true}


const levels=[{"blocks": [{"tier": 5, "row": 1, "col": 1}, {"tier": 1, "row": 0, "col": 0}, {"tier": 4, "row": 3, "col": 0}, {"tier": 3, "row": 3, "col": 2}, {"tier": 2, "row": 0, "col": 2}, {"tier": 1, "row": 4, "col": 2}], "gw": 4, "gh": 5, "time": 120}, {"blocks": [{"tier": 1, "row": 0, "col": 0}, {"tier": 1, "row": 3, "col": 3}, {"tier": 4, "row": 0, "col": 1}, {"tier": 3, "row": 1, "col": 0}, {"tier": 5, "row": 2, "col": 1}, {"tier": 2, "row": 3, "col": 0}], "gw": 4, "gh": 4, "time": 120}, {"blocks": [{"tier": 5, "row": 3, "col": 2}, {"tier": 3, "row": 3, "col": 0}, {"tier": 1, "row": 4, "col": 1}, {"tier": 2, "row": 2, "col": 1}, {"tier": 4, "row": 1, "col": 1}, {"tier": 1, "row": 0, "col": 3}], "gw": 4, "gh": 5, "time": 120}, {"blocks": [{"tier": 6, "row": 1, "col": 1}, {"tier": 5, "row": 3, "col": 3}, {"tier": 1, "row": 4, "col": 2}, {"tier": 2, "row": 2, "col": 0}, {"tier": 1, "row": 0, "col": 2}, {"tier": 3, "row": 3, "col": 0}, {"tier": 4, "row": 2, "col": 3}], "gw": 5, "gh": 5, "time": 120}, {"blocks": [{"tier": 6, "row": 1, "col": 1}, {"tier": 3, "row": 1, "col": 3}, {"tier": 1, "row": 0, "col": 3}, {"tier": 4, "row": 3, "col": 1}, {"tier": 4, "row": 0, "col": 1}, {"tier": 1, "row": 0, "col": 0}, {"tier": 2, "row": 3, "col": 3}, {"tier": 3, "row": 4, "col": 0}, {"tier": 2, "row": 2, "col": 0}, {"tier": 1, "row": 3, "col": 0}, {"tier": 1, "row": 2, "col": 4}], "gw": 5, "gh": 5, "time": 120}, {"blocks": [{"tier": 11, "row": 1, "col": 5}, {"tier": 10, "row": 6, "col": 0}, {"tier": 9, "row": 0, "col": 0}, {"tier": 8, "row": 2, "col": 0}, {"tier": 6, "row": 0, "col": 3}, {"tier": 1, "row": 0, "col": 7}, {"tier": 2, "row": 7, "col": 5}, {"tier": 2, "row": 5, "col": 0}, {"tier": 2, "row": 0, "col": 5}, {"tier": 1, "row": 0, "col": 6}, {"tier": 3, "row": 5, "col": 2}, {"tier": 1, "row": 5, "col": 1}, {"tier": 1, "row": 4, "col": 2}, {"tier": 1, "row": 2, "col": 4}, {"tier": 3, "row": 2, "col": 2}, {"tier": 3, "row": 4, "col": 0}, {"tier": 1, "row": 3, "col": 2}, {"tier": 7, "row": 3, "col": 3}, {"tier": 4, "row": 7, "col": 3}, {"tier": 12, "row": 4, "col": 5}], "gw": 8, "gh": 8, "time": 120}, {"blocks": [{"tier": 11, "row": 6, "col": 0}, {"tier": 3, "row": 5, "col": 6}, {"tier": 2, "row": 0, "col": 2}, {"tier": 10, "row": 2, "col": 0}, {"tier": 9, "row": 0, "col": 0}, {"tier": 5, "row": 4, "col": 2}, {"tier": 8, "row": 0, "col": 3}, {"tier": 9, "row": 2, "col": 3}, {"tier": 8, "row": 2, "col": 6}, {"tier": 6, "row": 4, "col": 0}, {"tier": 8, "row": 6, "col": 3}, {"tier": 2, "row": 2, "col": 5}, {"tier": 7, "row": 4, "col": 4}, {"tier": 10, "row": 6, "col": 6}, {"tier": 11, "row": 0, "col": 6}, {"tier": 4, "row": 4, "col": 7}], "gw": 9, "gh": 8, "time": 120}, {"blocks": [{"tier": 1, "row": 6, "col": 6}, {"tier": 1, "row": 5, "col": 6}, {"tier": 4, "row": 7, "col": 5}, {"tier": 3, "row": 7, "col": 3}, {"tier": 10, "row": 6, "col": 0}, {"tier": 4, "row": 5, "col": 0}, {"tier": 2, "row": 5, "col": 2}, {"tier": 2, "row": 4, "col": 3}, {"tier": 2, "row": 3, "col": 3}, {"tier": 2, "row": 4, "col": 0}, {"tier": 2, "row": 3, "col": 0}, {"tier": 4, "row": 2, "col": 0}, {"tier": 5, "row": 0, "col": 0}, {"tier": 12, "row": 0, "col": 2}, {"tier": 9, "row": 0, "col": 5}, {"tier": 4, "row": 2, "col": 5}, {"tier": 11, "row": 3, "col": 4}, {"tier": 8, "row": 3, "col": 1}, {"tier": 7, "row": 5, "col": 4}], "gw": 7, "gh": 8, "time": 120}];
let progress=JSON.parse(localStorage.getItem('ms_progress')||'{"unlocked":1}');
function saveProgress(){localStorage.setItem('ms_progress',JSON.stringify(progress))}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAY MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pgBks=[],pgSc=0,pgMv=0,pgUid=1,pgLvIdx=-1,pgW=8,pgH=8;
let pgDId=null,pgDBlk=null,pgSnp=null,pgItd=null,pgSPos=null;
let pgMAn=false,pgCPr=null;
let pgMM=false,pgMTgt=null,pgEDir=null,pgPSnap=null;
let pgLR=0,pgLC=0;
let pgTimeLeft=60,pgTimerId=null,pgDone=false;
const pgBd=document.getElementById('pgBoard');

function renderPlayMenu(){
  const grid=document.getElementById('levelGrid');
  
  if(!levels.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#6B5040;font-size:12px;padding:20px">No levels available.</div>';return}
  grid.innerHTML='';
  levels.forEach((lv,i)=>{
    const num=i+1,comp=num<progress.unlocked;
    const w=lv.gw||lv.gridSize||8,h=lv.gh||lv.gridSize||8,tm=lv.time||60;
    
    const d=document.createElement('div');d.className='lv-card';
    d.innerHTML=`<div class="lv-num">${num}</div><div class="lv-sz">${w}√ó${h} ¬∑ ${tm}s</div>`+(comp?'<div class="lv-check">‚úÖ</div>':'');
    d.addEventListener('click',()=>startLevel(i));grid.appendChild(d);
  });
  document.getElementById('playMenu').style.display='flex';
  document.getElementById('playGame').classList.add('hidden');
}

function startLevel(idx){
  if(pgTimerId){clearInterval(pgTimerId);pgTimerId=null}
  pgLvIdx=idx;pgSc=0;pgMv=0;pgUid=1;pgMAn=false;pgDone=false;
  pgDId=null;pgDBlk=null;pgSnp=null;pgItd=null;pgSPos=null;
  pgCPr=null;pgMM=false;pgMTgt=null;pgEDir=null;pgPSnap=null;
  const lv=levels[idx];
  pgW=lv.gw||lv.gridSize||8;pgH=lv.gh||lv.gridSize||8;
  GW=pgW;GH=pgH;
  pgTimeLeft=lv.time||60;
  sizeBoard(pgBd,pgW,pgH);
  pgBks=lv.blocks.map(b=>({id:pgUid++,tier:b.tier,row:b.row,col:b.col}));
  document.getElementById('playMenu').style.display='none';
  document.getElementById('playGame').classList.remove('hidden');
  document.getElementById('pgLabel').textContent='Level '+(idx+1);
  pgRender();pgUpdateTimer();
  pgTimerId=setInterval(()=>{
    if(pgDone)return;
    pgTimeLeft--;pgUpdateTimer();
    if(pgTimeLeft<=0){clearInterval(pgTimerId);pgTimerId=null;pgDone=true;pgFail()}
  },1000);
}
function pgUpdateTimer(){
  const el=document.getElementById('pgTimer');
  el.textContent=pgTimeLeft;
  el.style.color=pgTimeLeft<=10?'#FF6B6B':pgTimeLeft<=30?'#FECA57':'#FFD93D';
}
function pgFail(){
  pgDone=true;
  document.getElementById('failO').classList.remove('hid');
}

document.getElementById('pgBack').addEventListener('click',()=>{if(pgTimerId){clearInterval(pgTimerId);pgTimerId=null}renderPlayMenu()});
document.getElementById('pgRestart').addEventListener('click',()=>{if(pgLvIdx>=0)startLevel(pgLvIdx)});
document.getElementById('winMenu').addEventListener('click',()=>{document.getElementById('winO').classList.add('hid');renderPlayMenu()});
document.getElementById('winNext').addEventListener('click',()=>{document.getElementById('winO').classList.add('hid');if(pgLvIdx+1<levels.length)startLevel(pgLvIdx+1);else renderPlayMenu()});
document.getElementById('failMenu').addEventListener('click',()=>{document.getElementById('failO').classList.add('hid');renderPlayMenu()});
document.getElementById('failRetry').addEventListener('click',()=>{document.getElementById('failO').classList.add('hid');if(pgLvIdx>=0)startLevel(pgLvIdx)});

// ‚îÄ‚îÄ‚îÄ Game Engine ‚îÄ‚îÄ‚îÄ
function pgCp(t,r,c,ex){const ti=TI[t];if(r<0||c<0||r+ti.h>GH||c+ti.w>GW)return false;for(const b of pgBks){if(b.id===ex)continue;const bb=TI[b.tier];if(c<b.col+bb.w&&c+ti.w>b.col&&r<b.row+bb.h&&r+ti.h>b.row)return false}return true}

function pgSlide(tier,fR,fC,axis,tgt,exId){
  let cur=axis==='r'?fR:fC;if(cur===tgt)return cur;
  const dir=Math.sign(tgt-cur);let best=cur;
  for(let v=cur+dir;dir>0?v<=tgt:v>=tgt;v+=dir){if(pgCp(tier,axis==='r'?v:fR,axis==='c'?v:fC,exId))best=v;else break}
  return best;
}
function pgBest(tier,fR,fC,tR,tC,exId){
  const cA=pgSlide(tier,fR,fC,'c',tC,exId),rA=pgSlide(tier,fR,cA,'r',tR,exId);
  const rB=pgSlide(tier,fR,fC,'r',tR,exId),cB=pgSlide(tier,rB,fC,'c',tC,exId);
  return Math.abs(tR-rA)+Math.abs(tC-cA)<=Math.abs(tR-rB)+Math.abs(tC-cB)?{row:rA,col:cA}:{row:rB,col:cB};
}

function pgCheckEntry(blk,sr,sc2,ir,ic){
  const t=TI[blk.tier];
  for(const o of pgBks){
    if(o.id===blk.id||o.tier!==blk.tier)continue;
    const ot=TI[o.tier];let dir=null;
    if(sr===o.row){if(sc2+t.w===o.col)dir='left';if(o.col+ot.w===sc2)dir='right'}
    if(sc2===o.col){if(sr+t.h===o.row)dir='top';if(o.row+ot.h===sr)dir='bottom'}
    if(!dir)continue;
    const iovl=ic<o.col+ot.w&&ic+t.w>o.col&&ir<o.row+ot.h&&ir+t.h>o.row;
    const push=(dir==='left'&&ic>sc2)||(dir==='right'&&ic<sc2)||(dir==='top'&&ir>sr)||(dir==='bottom'&&ir<sr);
    if(iovl||push)return{target:o,dir};
  }return null;
}

function pgFM(blk,tg){
  const nx=MR[blk.tier];if(nx===null)return{disappear:true};
  const nt=TI[nx],fl=pgBks.filter(b=>b.id!==blk.id&&b.id!==tg.id);
  const cp2=(t,r,c)=>{const ti=TI[t];if(r<0||c<0||r+ti.h>GH||c+ti.w>GW)return false;return!fl.some(b=>{const bb=TI[b.tier];return c<b.col+bb.w&&c+ti.w>b.col&&r<b.row+bb.h&&r+ti.h>b.row})};
  for(const{r,c}of[{r:Math.min(blk.row,tg.row),c:Math.min(blk.col,tg.col)},{r:tg.row,c:tg.col},{r:blk.row,c:blk.col}])
    if(cp2(nx,r,c))return{row:r,col:c,tier:nx};
  for(let r=0;r<=GH-nt.h;r++)for(let c=0;c<=GW-nt.w;c++)if(cp2(nx,r,c))return{row:r,col:c,tier:nx};
  return null;
}

function pgRender(){
  pgBd.innerHTML='';
  for(let r=0;r<GH;r++)for(let c=0;c<GW;c++){const d=document.createElement('div');d.className='cell';d.style.cssText=`left:${GP+c*ST}px;top:${GP+r*ST}px;width:${CL}px;height:${CL}px;cursor:default`;pgBd.appendChild(d)}
  for(const b of pgBks)pgMkBlk(b);pgUS();
}

function pgMkBlk(b){
  const t=TI[b.tier],el=document.createElement('div');el.className='blk game';el.dataset.bid=b.id;
  const w=t.w*CL+(t.w-1)*GP,h=t.h*CL+(t.h-1)*GP;
  el.style.cssText=`left:${GP+b.col*ST}px;top:${GP+b.row*ST}px;width:${w}px;height:${h}px;background:linear-gradient(140deg,${t.bg},${t.sh});border-radius:${Math.min(w,h)>55?14:9}px;font-size:${Math.min(w,h)*0.48}px;z-index:10;box-shadow:0 3px 0 ${t.sh},0 4px 10px rgba(0,0,0,0.25),inset 0 2px 0 rgba(255,255,255,0.25)`;
  el.innerHTML=`<span class="em">${t.e}</span>`+((t.w>=2||t.h>=2)?`<span class="szl">${t.w}√ó${t.h}</span>`:'');
  el.addEventListener('mousedown',e=>pgOD(b,e));el.addEventListener('touchstart',e=>pgOD(b,e),{passive:false});
  pgBd.appendChild(el);
}

function pgGE(id){return pgBd.querySelector(`[data-bid="${id}"]`)}
function pgUS(){}

function pgAP(r1,c1,r2,c2){const cx=((c1+c2)/2+.5)*ST+GP,cy=((r1+r2)/2+.5)*ST+GP;["‚ú®","‚≠ê","üí´","üåü","üí•","‚ú®","‚≠ê","üí´","üåü","üí•","‚ú®","‚≠ê"].forEach((_,i)=>{const p=document.createElement('div');p.style.cssText=`position:absolute;left:${cx}px;top:${cy}px;font-size:16px;pointer-events:none;z-index:200;animation:pt .65s ease-out forwards`;p.style.setProperty('--dx',(Math.random()-.5)*120+'px');p.style.setProperty('--dy',(Math.random()-.5)*120+'px');p.textContent=["‚ú®","‚≠ê","üí´","üåü","üí•"][i%5];pgBd.appendChild(p);setTimeout(()=>p.remove(),700)})}

function pgSPv(id){
  if(pgCPr===id)return;
  if(pgCPr!==null){const ol=pgGE(pgCPr);if(ol){ol.style.animation='';const bk=pgBks.find(b=>b.id===pgCPr);if(bk){const t=TI[bk.tier];ol.style.boxShadow=`0 3px 0 ${t.sh},0 4px 10px rgba(0,0,0,0.25),inset 0 2px 0 rgba(255,255,255,0.25)`}}}
  pgCPr=id;
  if(id!==null){const el=pgGE(id);if(el){const bk=pgBks.find(b=>b.id===id);if(bk){const t=TI[bk.tier];el.style.animation='mp .5s ease-in-out infinite';el.style.boxShadow=`0 0 18px 5px rgba(255,215,0,0.5),0 3px 0 ${t.sh}`}}}
}

function gp(e){return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}

function pgOD(b,e){
  if(pgMAn||pgDone)return;e.preventDefault();const p=gp(e);
  GW=pgW;GH=pgH;
  pgDId=b.id;pgDBlk={...b};pgSPos=p;
  pgSnp={row:b.row,col:b.col};pgItd={row:b.row,col:b.col};
  pgLR=b.row;pgLC=b.col;
  pgMM=false;pgMTgt=null;pgEDir=null;pgPSnap=null;
  const el=pgGE(b.id);
  if(el){el.classList.add('dr');el.style.boxShadow=`0 10px 30px rgba(0,0,0,0.5),0 0 0 2px rgba(255,255,255,0.35),inset 0 2px 0 rgba(255,255,255,0.35)`}
}

function pgOM(e){
  if(pgDId===null||!pgSPos||!pgDBlk)return;e.preventDefault();
  GW=pgW;GH=pgH;
  const p=gp(e),dx=p.x-pgSPos.x,dy=p.y-pgSPos.y,o=pgDBlk,t=TI[o.tier];
  let tc=o.col+Math.round(dx/ST),tr=o.row+Math.round(dy/ST);
  tr=Math.max(0,Math.min(GH-t.h,tr));tc=Math.max(0,Math.min(GW-t.w,tc));
  pgItd={row:tr,col:tc};
  const el=pgGE(pgDId);

  if(pgMM){
    const tgt=pgMTgt,ot=TI[tgt.tier];let ex=false;
    if(pgEDir==='left'&&tc+t.w<=tgt.col)ex=true;
    if(pgEDir==='right'&&tc>=tgt.col+ot.w)ex=true;
    if(pgEDir==='top'&&tr+t.h<=tgt.row)ex=true;
    if(pgEDir==='bottom'&&tr>=tgt.row+ot.h)ex=true;
    if(ex){
      pgMM=false;pgMTgt=null;pgEDir=null;
      pgLR=pgPSnap.row;pgLC=pgPSnap.col;pgSnp={...pgPSnap};pgPSnap=null;
      if(el){el.classList.remove('merged');el.classList.add('dr');el.style.filter=''}
      pgSPv(null);
      const best=pgBest(o.tier,pgLR,pgLC,tr,tc,o.id);
      pgLR=best.row;pgLC=best.col;pgSnp={row:best.row,col:best.col};
      if(el){el.style.left=(GP+best.col*ST)+'px';el.style.top=(GP+best.row*ST)+'px'}
    }else{
      if(el){el.style.left=(GP+tgt.col*ST)+'px';el.style.top=(GP+tgt.row*ST)+'px'}
      pgSPv(tgt.id);
    }
    return;
  }

  const best=pgBest(o.tier,pgLR,pgLC,tr,tc,o.id);
  pgLR=best.row;pgLC=best.col;pgSnp={row:best.row,col:best.col};
  const entry=pgCheckEntry(pgDBlk,pgSnp.row,pgSnp.col,pgItd.row,pgItd.col);
  if(entry){
    pgMM=true;pgMTgt=entry.target;pgEDir=entry.dir;pgPSnap={row:pgSnp.row,col:pgSnp.col};
    if(el){el.classList.add('merged');el.style.left=(GP+entry.target.col*ST)+'px';el.style.top=(GP+entry.target.row*ST)+'px'}
    pgSPv(entry.target.id);return;
  }
  if(el){el.style.left=(GP+best.col*ST)+'px';el.style.top=(GP+best.row*ST)+'px'}
  pgSPv(null);
}

function pgOU(){
  if(pgDId===null||!pgDBlk){pgCD();return}
  GW=pgW;GH=pgH;
  const ob=pgDBlk;
  if(pgMM&&pgMTgt){
    const tgt=pgMTgt,sr=pgPSnap.row,sc=pgPSnap.col;
    const moved=sr!==ob.row||sc!==ob.col;
    if(moved)pgUB(ob.id,sr,sc);
    const res=pgFM({...ob,row:sr,col:sc},tgt);
    if(res&&res.disappear){
      pgAM([ob.id,tgt.id],'po',()=>{pgBks=pgBks.filter(b=>b.id!==ob.id&&b.id!==tgt.id);pgRender();pgCW()});
      pgSc+=1000;pgMv++;pgAP(sr,sc,tgt.row,tgt.col);
    }else if(res){
      pgAM([ob.id,tgt.id],'gl',()=>{pgBks=pgBks.filter(b=>b.id!==ob.id&&b.id!==tgt.id);pgBks.push({id:pgUid++,tier:res.tier,row:res.row,col:res.col});pgRender();pgCW()});
      pgSc+=res.tier*50;pgMv++;
    }else{
      pgUB(ob.id,sr,sc);if(moved)pgMv++;
    }
    pgSPv(null);pgCD();pgUS();return;
  }
  if(!pgSnp){pgCD();return}
  const sr=pgSnp.row,sc=pgSnp.col,moved=sr!==ob.row||sc!==ob.col;
  if(moved){pgUB(ob.id,sr,sc);pgMv++}
  pgSPv(null);pgCD();pgUS();
}

function pgUB(id,r,c){const b=pgBks.find(x=>x.id===id);if(b){b.row=r;b.col=c}const el=pgGE(id);if(el){el.style.left=(GP+c*ST)+'px';el.style.top=(GP+r*ST)+'px'}}
function pgAM(ids,type,cb){pgMAn=true;for(const id of ids){const el=pgGE(id);if(el){el.style.zIndex=60;el.classList.remove('dr','merged');el.style.filter='';el.style.animation=type==='po'?'po .35s ease-out forwards':'gl .35s ease-out'}}setTimeout(()=>{pgMAn=false;cb()},350)}
function pgCD(){if(pgDId!==null){const el=pgGE(pgDId);if(el){el.classList.remove('dr','merged');el.style.filter='';const bk=pgBks.find(b=>b.id===pgDId);if(bk){const t=TI[bk.tier];el.style.boxShadow=`0 3px 0 ${t.sh},0 4px 10px rgba(0,0,0,0.25),inset 0 2px 0 rgba(255,255,255,0.25)`}}}pgDId=null;pgDBlk=null;pgSPos=null;pgSnp=null;pgItd=null;pgMM=false;pgMTgt=null;pgEDir=null;pgPSnap=null}
function pgCW(){
  if(pgBks.length===1){
    pgDone=true;if(pgTimerId){clearInterval(pgTimerId);pgTimerId=null}
    document.getElementById('winSt').textContent=`Time remaining: ${pgTimeLeft}s`;
    document.getElementById('winO').classList.remove('hid');
    if(pgLvIdx+1>=progress.unlocked){progress.unlocked=pgLvIdx+2;saveProgress()}
    document.getElementById('winNext').style.display=(pgLvIdx+1<levels.length)?'':'none';
  }
}

window.addEventListener('mousemove',pgOM);window.addEventListener('mouseup',pgOU);
window.addEventListener('touchmove',pgOM,{passive:false});window.addEventListener('touchend',pgOU);

renderPlayMenu();
})();
</script>
</body>
</html>
